<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assistant v2 — Socket.IO Test</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .row { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    input[type="text"] { flex: 1; padding: 0.6rem 0.8rem; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 0.6rem 1rem; border: 1px solid #999; background: #f7f7f7; border-radius: 8px; cursor: pointer; }
    button:hover { background: #eee; }
    #conversation { border: 1px solid #ddd; border-radius: 10px; padding: 1rem; height: 360px; overflow-y: auto; background: #fafafa; }
    .user { margin: 0.4rem 0; font-weight: 600; }
    .assistant { margin: 0.4rem 0 1rem 0.6rem; color: #123; white-space: pre-wrap; }
    #log { margin-top: 1rem; font-size: 0.85rem; color: #555; white-space: pre-wrap; }
  </style>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <h1>Assistant v2 (Socket.IO)</h1>

  <div class="row">
    <input id="prompt" type="text" placeholder="Type a message…" />
    <button id="send">Send</button>
    <button id="interrupt">Interrupt</button>
  </div>

  <div id="conversation"></div>
  <div id="log"></div>

  <script>
    const convoEl = document.getElementById("conversation");
    const logEl = document.getElementById("log");
    const promptEl = document.getElementById("prompt");

    const log = (m) => { logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };
    const addUser = (t) => {
      const el = document.createElement("div");
      el.className = "user";
      el.textContent = "You: " + t;
      convoEl.appendChild(el);
      convoEl.scrollTop = convoEl.scrollHeight;
    };
    let currentReplyEl = null;

    const socket = io("/", { path: "/socket.io" });

    socket.on("connect", () => log("[sio] connected " + socket.id));
    socket.on("disconnect", () => log("[sio] disconnected"));
    socket.on("connect_error", (e) => log("[sio] error: " + e.message));

    socket.on("RunStarted", ({ runId }) => {
      currentReplyEl = document.createElement("div");
      currentReplyEl.className = "assistant";
      convoEl.appendChild(currentReplyEl);
      convoEl.scrollTop = convoEl.scrollHeight;
      log(`Run started (id=${runId})`);
    });

    socket.on("ChatChunk", ({ chunk }) => {
      if (currentReplyEl) {
        currentReplyEl.textContent += chunk;
        convoEl.scrollTop = convoEl.scrollHeight;
      }
    });

    socket.on("ChatDone", ({ runId }) => {
      log(`Run done (id=${runId})`);
      currentReplyEl = null;
    });

    socket.on("Interrupted", ({ runId }) => {
      log(`Run interrupted${runId ? " (id=" + runId + ")" : ""}`);
      currentReplyEl = null;
    });

    socket.on("Error", (msg) => {
      log("Error: " + (msg.message || JSON.stringify(msg)));
    });

    document.getElementById("send").onclick = () => {
      const text = promptEl.value.trim();
      if (!text) return;
      addUser(text);
      socket.emit("Chat", { text });
      promptEl.value = "";
      promptEl.focus();
    };

    document.getElementById("interrupt").onclick = () => {
      socket.emit("Interrupt");
    };

    promptEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") document.getElementById("send").click();
    });
  </script>
</body>
</html>
